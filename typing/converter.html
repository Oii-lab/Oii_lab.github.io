<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Oii_lab | 格式轉換工具</title>
    <link rel="stylesheet" href="../styles.css" /> 
    <style>
        body { display: block; padding: 0; margin: 0; min-height: auto; font-family: 'Inter', sans-serif; }
        .content-section { max-width: 900px; margin: 0 auto; padding: 100px 20px 40px 20px; }
        .converter-box { background-color: #1a1a1a; padding: 30px; border-radius: 12px; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.2); color: #fff; }
        h2 { color: #00ffff; margin-bottom: 20px; }
        
        .upload-area { border: 2px dashed rgba(0, 255, 255, 0.3); padding: 40px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; margin-bottom: 20px; }
        .upload-area:hover { border-color: #00ffff; background: rgba(0, 255, 255, 0.05); }
        
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 12px; border: 1px solid #00ffff; background: transparent; color: #00ffff; cursor: pointer; border-radius: 6px; font-weight: bold; }
        .mode-btn.active { background: #00ffff; color: #000; }

        textarea { width: 100%; height: 350px; background: #0d0d0d; color: #00ff00; border: 1px solid #333; padding: 15px; font-family: 'Roboto Mono', monospace; border-radius: 8px; margin-top: 10px; line-height: 1.5; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 15px; border: 2px solid #00ffff; background: transparent; color: #00ffff; font-weight: bold; cursor: pointer; border-radius: 8px; transition: 0.3s; text-align: center; text-decoration: none; }
        .btn:hover { background: #00ffff; color: #000; box-shadow: 0 0 15px #00ffff; }
        .small { color: #888; font-size: 0.9em; margin-top: 10px; }
        .error-msg { color: #ff5555; font-size: 0.85em; margin-top: 5px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="container nav-content">
            <a href="../index.html" class="logo">Oii Lab</a> 
            <nav class="nav-links">
                <a href="#notes">最新筆記</a>
                <a href="typing.html">Quiz Lab</a>
                <a href="https://www.youtube.com/@Oii_lab" target="_blank" rel="noopener noreferrer">C++ Shorts</a>
            </nav>
        </div>
    </header>

    <div class="content-section">
        <div class="converter-box">
            <h2>題目格式轉換器 (通用增強版)</h2>
            <p class="small">適配多種換行與標點格式，自動去重並提取題目與答案。</p>
            
            <div class="mode-selector">
                <button class="mode-btn active" id="modeBlank">填充題模式</button>
                <button class="mode-btn" id="modeMCQ">選擇題模式</button>
            </div>

            <div class="upload-area" id="dropZone">
                <p id="fileNameDisplay">點擊或拖放原始題庫 (.txt) 至此</p>
                <input type="file" id="fileInput" accept=".txt" hidden>
            </div>

            <div class="btn-group">
                <button class="btn" id="convertBtn">立即轉換</button>
                <button class="btn" id="downloadBtn" style="display:none;">下載轉換後的 TXT</button>
            </div>

            <textarea id="outputPreview" placeholder="轉換後的預覽將顯示於此..."></textarea>
            <div id="errorLog" class="error-msg"></div>
        </div>
    </div>

    <script>
        let currentMode = 'blank'; 
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const outputPreview = document.getElementById('outputPreview');
        const downloadBtn = document.getElementById('downloadBtn');
        const errorLog = document.getElementById('errorLog');
        let convertedText = "";

        // 模式切換
        document.getElementById('modeBlank').onclick = function() {
            currentMode = 'blank';
            this.classList.add('active');
            document.getElementById('modeMCQ').classList.remove('active');
        };
        document.getElementById('modeMCQ').onclick = function() {
            currentMode = 'mcq';
            this.classList.add('active');
            document.getElementById('modeBlank').classList.remove('active');
        };

        // 檔案上傳處理
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = () => {
            if(fileInput.files.length > 0) document.getElementById('fileNameDisplay').textContent = "已選取: " + fileInput.files[0].name;
        };

        // 轉換按鈕觸發
        document.getElementById('convertBtn').onclick = function() {
            const file = fileInput.files[0];
            if(!file) return alert("請先選擇檔案！");

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                errorLog.textContent = ""; // 清除舊錯誤
                
                if(currentMode === 'blank') {
                    convertedText = processBlank(text);
                } else {
                    convertedText = processMCQ(text);
                }
                
                outputPreview.value = convertedText;
                downloadBtn.style.display = 'block';
            };
            // 嘗試以 UTF-8 讀取，若有亂碼需求可在此調整
            reader.readAsText(file);
        };

        // 下載功能
        downloadBtn.onclick = function() {
            const blob = new Blob([convertedText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `converted_${currentMode}_${Date.now()}.txt`;
            a.click();
        };

        // --- 核心邏輯：填充題 (增強容錯版) ---
        function processBlank(text) {
            let results = [];
            let seen = new Set();
            let newId = 1;
            let errors = [];

            // 寬鬆切割：只要有「題目」二字就視為新區塊
            const blocks = text.split(/題目/);

            for(let block of blocks) {
                block = block.trim();
                if(!block) continue;

                // 1. 抓取題目內容：支援有無括號、多種冒號、換行
                // 邏輯：從「填充」或開始處抓到「正確答案」或「答案」之前
                const qMatch = block.match(/(?:\(填充\))?[:：\s]*([\s\S]+?)(?=\r?\n\s*(?:正確答案|答案)|$)/i);
                const ansMatch = block.match(/(?:正確答案|答案)[:：\s]*([\s\S]+?)$/i);

                if(!qMatch || !ansMatch) {
                    if (block.length > 10) errors.push(`[填充] 解析失敗，請檢查格式：${block.substring(0, 20)}...`);
                    continue;
                }

                let qTextRaw = qMatch[1].trim();
                let ansText = ansMatch[1].trim();

                // 2. 替換填充符號：支援 ___, ( ), （ ）, .......
                let formattedQ = qTextRaw.replace(/[＿_]{2,}|[.]+ {0,1}[.]{1,}|[(（]\s*[)）]/g, `[${ansText}]`);
                
                // 如果題目內沒找到填充符號，則補在結尾
                if(!formattedQ.includes(`[${ansText}]`)) formattedQ = `${qTextRaw} [${ansText}]`;

                // 3. 整理格式：移除多餘換行，轉為單行
                let qFinal = formattedQ.split(/\r?\n+/).map(s => s.trim()).filter(s => s).join(" ");
                
                // 4. 去重
                let lookupKey = qFinal.replace(/[^\w\u4e00-\u9fa5]/g, '');
                if(lookupKey && !seen.has(lookupKey)) {
                    seen.add(lookupKey);
                    results.push(`${newId}. ${qFinal}`);
                    newId++;
                }
            }
            if(errors.length > 0) errorLog.textContent = errors.join("\n");
            return results.join("\n");
        }

        // --- 核心邏輯：選擇題 (增強容錯版) ---
        function processMCQ(text) {
            let results = [];
            let seen = new Set();
            let newId = 1;
            let errors = [];
            
            const blocks = text.split(/題目/);

            for(let block of blocks) {
                block = block.trim();
                if(!block) continue;

                // 1. 抓題目：支援「(選擇)」或直接開始
                const qMatch = block.match(/(?:\(選擇\))?[:：\s]*([\s\S]+?)(?=\r?\n\s*(?:選項|正確答案|答案)|$)/i);
                if(!qMatch) {
                    if (block.length > 10) errors.push(`[選擇] 無法抓取題目：${block.substring(0, 20)}...`);
                    continue;
                }
                let qClean = qMatch[1].split(/\r?\n+/).map(s => s.trim()).filter(s => s).join(" ");

                // 2. 去重判斷
                let lookupKey = qClean.replace(/[^\w\u4e00-\u9fa5]/g, '');
                if(seen.has(lookupKey)) continue;

                // 3. 抓選項：支援 A. (A) A: A、 等多種格式
                const optBlockMatch = block.match(/(?:選項[:：\s]*)?([\s\S]+?)(?=\r?\n\s*(?:正確答案|答案)|$)/i);
                let formattedOptions = [];
                if(optBlockMatch) {
                    const lines = optBlockMatch[1].trim().split(/\r?\n/);
                    lines.forEach(line => {
                        const l = line.trim();
                        if(!l) return;
                        const optMatch = l.match(/^[(（]?([A-Za-z])[)）]?[\.．、:：\s]+([\s\S]+)$/);
                        if(optMatch) {
                            formattedOptions.push(`${optMatch[1].toUpperCase()}: ${optMatch[2].trim()}`);
                        }
                    });
                }

                // 4. 抓正確答案
                const ansMatch = block.match(/(?:正確答案|答案)[:：\s]*([A-Za-z\s,，]+)/i);
                let ansStr = "答案: 未知";
                if(ansMatch) {
                    const labels = ansMatch[1].split(/[,，\s]+/).map(s => s.trim().toUpperCase()).filter(s => s);
                    ansStr = `答案: ${labels.join(",")}`;
                } else {
                    errors.push(`[選擇] 題目 "${qClean.substring(0,10)}..." 找不到正確答案。`);
                }

                // 5. 組合
                seen.add(lookupKey);
                results.push(`${newId}. ${qClean} | ${formattedOptions.join(" | ")} | ${ansStr}`);
                newId++;
            }
            if(errors.length > 0) errorLog.textContent = errors.join("\n");
            return results.join("\n");
        }
    </script>
</body>
</html>
